<!DOCTYPE html>
<html lang="en">

<head>
    <title>Send a Notification</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="./css/style.css" rel="stylesheet" type="text/css">
</head>

<body>
     <nav>
        <ul class="columns_4">
            <li><a href="login.html">Login</a></li>
            <li><a href="send_notification.html">Send Notifications</a></li>
            <li><a href="template.html">Templates</a></li>
            <li><a href="review_logs.html">Notification Logs</a></li>
        </ul>
    </nav>
    <main>
        <h1>Send a Notification</h1>
        <form  id="notificationForm" method="post" action="../Data/send_email.php" onsubmit="submitForm(event)">
            <div class="templateBox">
                <label for="template">Select Template:</label>
                <select id="template" name="template" onchange="loadTemplate()"></select>
            </div>
            <div class="subjectBox">
                <label for="subject">Subject:</label>
                <input type="text" name="subject" id="subject" required>
            </div>
            <label id="bodyLabel" for="body">Body:</label>
            <textarea name="body" class="body" rows="15" id="body" placeholder="Type your notification message here" required ></textarea>
            <div class="split-1-1">
                <input class="button" type="submit" value="Send"> 
                <input class="button" type="button" value="Clear">
            </div>
        </form>
    </main>
    <footer>
        <h3>Copyright &copy; 2023 Portland Community College </h3>
        <img src="./images/favicon.ico" alt="PCC Logo" width="50" height="50">
    </footer>
    <script>
         // Add an event listener to the "Clear" button
        const clearButton = document.querySelector('.button[value="Clear"]');
        clearButton.addEventListener('click', function () {
            document.getElementById('subject').value = ''; // Clear the subject field
            document.getElementById('body').value = ''; // Clear the body field
        });

        function submitForm(event) {
            event.preventDefault();
    
            const form = event.target;
            const subject = document.getElementById('subject').value;
            const body = document.getElementById('body').value;
            
            if (subject.trim() === '' || body.trim() === '') {
                alert("Please fill out both Subject and Body fields before sending the email.");
                return;
            }

            const formData = new FormData(form);
    
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "../Data/email_notification_handler.php", true);
    
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        const response = xhr.responseText;
    
                        if (response.trim() === "Email sent successfully!") {
                            alert("Email sent successfully!");
                        } else {
                            alert("Failed to send email");
                        }
                        console.log(xhr);
                    }
                }
            };
    
            xhr.send(formData);
        }
         function loadTemplate() {
             const templateSelect = document.getElementById('template');
             const selectedTemplate = templateSelect.options[templateSelect.selectedIndex];

             // Access the subject and body elements
             const subjectField = document.getElementById('subject');
             const bodyField = document.getElementById('body');

             // Update the subject and body fields with the selected template values
             subjectField.value = selectedTemplate.dataset.name || '';
             bodyField.value = selectedTemplate.dataset.message || '';
             // Adjust the width of the select box based on the length of the selected template name
             templateSelect.style.width = selectedTemplate.textContent.length * 10 + 'px';
         }

         // Fetch templates and populate the select element
         async function fetchAndPopulateTemplates() {
             const templateSelect = document.getElementById('template');

             // Fetch templates
             const response = await fetch("../Data/fetch-templates.php", {
                 method: "GET",
                 headers: {
                     "Content-Type": "application/json",
                 },
                 mode: "cors",
             });

             if (response.ok || response.status === 200) {
                 const data = await response.json();

                 // Clear existing options
                 templateSelect.innerHTML = "";

                 // Populate the select element with template names
                 data.forEach(template => {
                     const option = document.createElement("option");
                     option.value = template.name;
                     option.textContent = template.name;
                     // additional data
                     option.dataset.name = template.name;
                     option.dataset.message = template.message;
                     templateSelect.appendChild(option);
                 });
             }
         }

         // Call function to fetch and populate templates when the page loads
         document.addEventListener("DOMContentLoaded", fetchAndPopulateTemplates);
    </script>
    
</body>


</html>